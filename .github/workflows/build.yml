name: Build Celeste Mod

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET Framework
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '4.8.x'
        
    - name: Build mod with Docker
      run: |
        docker-compose build build
        docker-compose run --rm build
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: desolozatnas-mod
        path: |
          Code/
          everest.yaml
          
    - name: Check for mod DLL
      run: |
        if (Test-Path "Code/net48/Desolo_Zantas.dll") {
          Write-Host "✅ Mod DLL built successfully"
          Get-Item "Code/net48/Desolo_Zantas.dll" | Select-Object Name, Length, LastWriteTime
        } else {
          Write-Host "❌ Mod DLL not found"
          exit 1
        }
      shell: powershell

  # Container build test
  container-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build development container
      run: |
        docker build -t desolozatnas-dev -f Dockerfile.dev .
        
    - name: Build CI container
      run: |
        docker build -t desolozatnas-build -f Dockerfile.build .
        
    - name: Test container builds
      run: |
        echo "✅ All containers built successfully"
        docker images | grep desolozatnas

  # Release build (only on tags)
  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build, container-test]
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build release mod
      run: |
        docker-compose build build
        docker-compose run --rm build
        
    - name: Create release package
      run: |
        $version = $env:GITHUB_REF -replace 'refs/tags/', ''
        $packageName = "DesoloZatnas-$version.zip"
        
        # Create mod package
        Compress-Archive -Path @(
          "Code/",
          "Graphics/",
          "Audio/",
          "Dialog/",
          "Maps/",
          "metadata/",
          "everest.yaml"
        ) -DestinationPath $packageName
        
        Write-Host "Created package: $packageName"
      shell: powershell
        
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false